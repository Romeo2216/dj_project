{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Liste des paris</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background-color: #f9fafb;
      color: #111827;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #2563eb;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 1.4rem;
      margin: 0;
    }
    nav a, nav form button {
      color: white;
      text-decoration: none;
      margin-left: 1rem;
      font-weight: 600;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }
    nav a:hover, nav form button:hover {
      text-decoration: underline;
    }

    main {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .pari {
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 1rem 1.5rem;
      margin-bottom: 1.25rem;
      border: 1px solid #e5e7eb;
    }

    .pari h2 {
      margin: 0 0 .5rem 0;
      font-size: 1.1rem;
    }

    /* --- Progression fusionnée (vert -> rouge) --- */
    .progress-merged {
      width: 100%;
      height: 22px;
      border-radius: 12px;
      background: #e5e7eb;
      overflow: hidden;
      position: relative;
      margin-top: .5rem;
      margin-bottom: .5rem;
    }
    .progress-inner {
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, #16a34a var(--p), #dc2626 var(--p));
      transition: all .3s ease-in-out;
    }

    .vote-buttons {
      margin-top: .6rem;
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .btn {
      display: inline-block;
      border: none;
      border-radius: 8px;
      padding: .4rem .8rem;
      font-weight: 700;
      color: white;
      cursor: pointer;
    }
    .btn.oui { background: #16a34a; }
    .btn.non { background: #dc2626; }
    .btn.oui:hover { background: #15803d; }
    .btn.non:hover { background: #b91c1c; }
    .btn.validate { background: #2563eb; }
    .btn.validate:hover { background: #1d4ed8; }

    .result {
      margin-top: .4rem;
      font-size: .95rem;
      color: #374151;
    }

    .meta {
      font-size: .85rem;
      color: #6b7280;
    }
    .solde {
      text-align: right;
      font-weight: 600;
      color: #374151;
    }

    input[type=number] {
      width: 90px;
      padding: .3rem .4rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
    }
  </style>
</head>
<body>
  <header>
    <h1>Liste des paris</h1>
    <nav>
      <a href="/">Accueil</a>
      {% if user.is_authenticated %}
        <a href="{% url 'profile' %}">Profil</a>
        <a href="{% url 'logout_any' %}">Déconnexion</a>
      {% else %}    
        <a href="{% url 'login' %}">Connexion</a>
      {% endif %}
    </nav>
  </header>

  <main>
    {% if user.is_authenticated %}
      <p class="solde">Solde : {{ user.wallet.points }} points</p>
    {% endif %}

    {% for pari in paris %}
      <div class="pari">
        <h2>{{ pari.description }}</h2>
        <p class="meta">Créé le {{ pari.created_at|date:"d/m/Y H:i" }}</p>

        {% with total=pari.nb_oui|add:pari.nb_non %}
          {% if total > 0 %}
            {% widthratio pari.nb_oui total 100 as p_oui %}
            <div class="progress-merged" title="Oui {{ p_oui }}% / Non '{{ 100|add:-p_oui }'}%">
              <div class="progress-inner" style="--p: {{ p_oui }}%;"></div>
            </div>
          {% else %}
            <div class="progress-merged">
              <div class="progress-inner" style="--p: 50%; opacity:.2;"></div>
            </div>
          {% endif %}
        {% endwith %}

        <p class="meta">Oui : {{ pari.nb_oui }} — Non : {{ pari.nb_non }}</p>

        {% if pari.resolved %}
          <p class="result">
            ✅ Pari résolu — résultat :
            {% if pari.result == 'oui' %}
              <strong style="color:#16a34a;">OUI</strong>
            {% else %}
              <strong style="color:#dc2626;">NON</strong>
            {% endif %}
            (le {{ pari.resolved_at|date:"d/m/Y H:i" }})
          </p>
        {% else %}
          {% if user.is_authenticated %}
            {% if pari.my_vote %}
              <p class="result">
                Vous avez voté :
                {% if pari.my_vote.choice == 'oui' %}
                  <strong style="color:#16a34a;">OUI</strong>
                {% else %}
                  <strong style="color:#dc2626;">NON</strong>
                {% endif %}
                — Mise : <strong>{{ pari.my_vote.stake_points }}</strong> points.
                <em>(définitif)</em>
              </p>
            {% else %}
              <div class="vote-buttons">
                <form action="{% url 'bet' pari.id 'oui' %}" method="post" style="display:inline-flex;gap:.4rem;align-items:center;">
                  {% csrf_token %}
                  <input type="number" name="points" min="1" step="1" value="10">
                  <button type="submit" class="btn oui">Parier OUI</button>
                </form>
                <form action="{% url 'bet' pari.id 'non' %}" method="post" style="display:inline-flex;gap:.4rem;align-items:center;">
                  {% csrf_token %}
                  <input type="number" name="points" min="1" step="1" value="10">
                  <button type="submit" class="btn non">Parier NON</button>
                </form>
              </div>
            {% endif %}

            {% if user.is_superuser %}
              <div style="margin-top:.8rem;">
                <form action="{% url 'resolve_pari' pari.id 'oui' %}" method="post" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn validate">Valider : OUI</button>
                </form>
                <form action="{% url 'resolve_pari' pari.id 'non' %}" method="post" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn validate">Valider : NON</button>
                </form>
              </div>
            {% endif %}
          {% else %}
            <p><a href="{% url 'login' %}?next={{ request.path }}">Connectez-vous pour parier</a></p>
          {% endif %}
        {% endif %}
      </div>
    {% empty %}
      <p>Aucun pari pour le moment.</p>
    {% endfor %}
  </main>
</body>
</html>
